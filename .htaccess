# Apache Configuration for Executive Power SPA
# Configuración para Single Page Application (React)

# Habilitar el motor de reescritura
RewriteEngine On

# Configuraciones de seguridad
# =============================

# Ocultar información del servidor
ServerTokens Prod
Header unset Server
Header always set X-Content-Type-Options nosniff
Header always set X-Frame-Options DENY
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"

# Prevenir acceso a archivos sensibles
<FilesMatch "\.(env|log|json|ts|tsx|js\.map|css\.map)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Proteger archivos de configuración
<Files ~ "^(package\.json|package-lock\.json|tsconfig\.json|vite\.config\.ts|tailwind\.config\.ts|postcss\.config\.js|drizzle\.config\.ts)$">
    Order Allow,Deny
    Deny from all
</Files>

# Prevenir acceso a directorios sensibles
RedirectMatch 404 /\..*$
RedirectMatch 404 /node_modules/.*$
RedirectMatch 404 /src/.*$
RedirectMatch 404 /server/.*$

# Compresión GZIP
# ================
<IfModule mod_deflate.c>
    # Comprimir texto, html, javascript, css, xml
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/ld+json
    
    # Comprimir fuentes
    AddOutputFilterByType DEFLATE font/truetype
    AddOutputFilterByType DEFLATE font/opentype
    AddOutputFilterByType DEFLATE application/font-woff
    AddOutputFilterByType DEFLATE application/font-woff2
    AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
</IfModule>

# Cache de archivos estáticos
# ============================
<IfModule mod_expires.c>
    ExpiresActive On
    
    # HTML (no cache)
    ExpiresByType text/html "access plus 0 seconds"
    
    # CSS y JavaScript
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType application/x-javascript "access plus 1 year"
    
    # Imágenes
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # Fuentes
    ExpiresByType font/truetype "access plus 1 year"
    ExpiresByType font/opentype "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    ExpiresByType application/vnd.ms-fontobject "access plus 1 year"
    
    # Documentos
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType text/plain "access plus 1 month"
    ExpiresByType application/vnd.openxmlformats-officedocument.wordprocessingml.document "access plus 1 month"
    ExpiresByType application/vnd.openxmlformats-officedocument.spreadsheetml.sheet "access plus 1 month"
</IfModule>

# Headers de cache alternativos (si mod_expires no está disponible)
<IfModule mod_headers.c>
    # Cache para archivos estáticos
    <FilesMatch "\.(css|js|png|jpg|jpeg|gif|webp|svg|woff|woff2|ttf|eot)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>
    
    # No cache para HTML
    <FilesMatch "\.(html|htm)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>
</IfModule>

# Manejo de rutas para SPA (Single Page Application)
# ===================================================

# Si el proyecto está en producción y usa archivos estáticos
# Redirigir todas las rutas no encontradas al index.html
<IfModule mod_rewrite.c>
    # IMPORTANTE: Permitir rutas de API si el servidor Express está disponible
    # RewriteRule ^api/(.*)$ - [L,R=404]
    
    # No reescribir si el archivo o directorio existe
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    
    # No reescribir para archivos de assets
    RewriteCond %{REQUEST_URI} !^/assets/
    RewriteCond %{REQUEST_URI} !^/favicon\.ico$
    RewriteCond %{REQUEST_URI} !^/robots\.txt$
    RewriteCond %{REQUEST_URI} !^/sitemap\.xml$
    
    # No reescribir para rutas de API
    RewriteCond %{REQUEST_URI} !^/api/
    
    # No reescribir para archivos descargables
    RewriteCond %{REQUEST_URI} !\.(docx|pdf|xlsx|zip)$
    
    # Redirigir todo al index.html para el router de React
    RewriteRule ^(.*)$ /index.html [L]
</IfModule>

# Configuración de tipos MIME
# ============================
<IfModule mod_mime.c>
    # JavaScript
    AddType application/javascript .js
    AddType application/javascript .mjs
    
    # CSS
    AddType text/css .css
    
    # Fuentes web
    AddType font/woff .woff
    AddType font/woff2 .woff2
    AddType application/vnd.ms-fontobject .eot
    AddType font/truetype .ttf
    AddType font/opentype .otf
    
    # Imágenes modernas
    AddType image/webp .webp
    AddType image/svg+xml .svg
    
    # JSON
    AddType application/json .json
    AddType application/ld+json .jsonld
    
    # Manifesto web
    AddType application/manifest+json .webmanifest
    
    # Documentos Office
    AddType application/vnd.openxmlformats-officedocument.wordprocessingml.document .docx
    AddType application/vnd.openxmlformats-officedocument.spreadsheetml.sheet .xlsx
    AddType application/pdf .pdf
</IfModule>

# Configuración para HTTPS (recomendado)
# =======================================
<IfModule mod_rewrite.c>
    # Forzar HTTPS (descomenta si tienes SSL configurado)
    # RewriteCond %{HTTPS} off
    # RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</IfModule>

# Prevenir hotlinking de imágenes (opcional)
# ===========================================
<IfModule mod_rewrite.c>
    # RewriteCond %{HTTP_REFERER} !^$
    # RewriteCond %{HTTP_REFERER} !^https?://(www\.)?tudominio\.com [NC]
    # RewriteRule \.(jpg|jpeg|png|gif|webp)$ - [F]
</IfModule>

# Configuración específica para el CV download
# =============================================
<Files "MAURICIO_URIBE_CV.docx">
    Header set Content-Type "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
    Header set Content-Disposition "attachment; filename=\"MAURICIO_URIBE_CV.docx\""
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires "0"
</Files>

<Files "Executive_CV.txt">
    Header set Content-Type "application/octet-stream"
    Header set Content-Disposition "attachment; filename=Executive_CV.txt"
</Files>

# Error pages personalizadas (opcional)
# ======================================
# ErrorDocument 404 /404.html
# ErrorDocument 500 /500.html
